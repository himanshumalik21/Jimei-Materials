// technical-resources.js
(function() {
    'use strict';
    
    // DOM Ready
    document.addEventListener('DOMContentLoaded', function() {
        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        // Initialize components
        initCategoryFilter();
        initSearch();
        initLazyLoading();
        initAccessibility();
    });
    
    // Category filter functionality
    function initCategoryFilter() {
        const categoryButtons = document.querySelectorAll('.category-btn');
        const resourceCards = document.querySelectorAll('[data-category]');
        
        if (!categoryButtons.length || !resourceCards.length) return;
        
        categoryButtons.forEach(button => {
            button.addEventListener('click', function() {
                const category = this.getAttribute('data-category');
                
                // Update active state
                categoryButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                });
                this.classList.add('active');
                this.setAttribute('aria-selected', 'true');
                
                // Filter cards
                resourceCards.forEach(card => {
                    if (category === 'all' || card.getAttribute('data-category') === category) {
                        card.style.display = 'block';
                        card.setAttribute('aria-hidden', 'false');
                    } else {
                        card.style.display = 'none';
                        card.setAttribute('aria-hidden', 'true');
                    }
                });
                
                // Announce filter change for screen readers
                const announcement = document.createElement('div');
                announcement.className = 'sr-only';
                announcement.setAttribute('role', 'status');
                announcement.setAttribute('aria-live', 'polite');
                announcement.textContent = `Showing ${category === 'all' ? 'all resources' : category + ' resources'}`;
                document.body.appendChild(announcement);
                setTimeout(() => announcement.remove(), 1000);
            });
        });
    }
    
    // Search functionality
    function initSearch() {
        const searchInput = document.querySelector('.search-input');
        const resourceCards = document.querySelectorAll('[data-category]');
        
        if (!searchInput || !resourceCards.length) return;
        
        searchInput.addEventListener('input', debounce(function() {
            const searchTerm = this.value.toLowerCase().trim();
            let visibleCount = 0;
            
            resourceCards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const description = card.querySelector('p').textContent.toLowerCase();
                const category = card.getAttribute('data-category');
                
                if (searchTerm === '' || 
                    title.includes(searchTerm) || 
                    description.includes(searchTerm) ||
                    category.includes(searchTerm)) {
                    card.style.display = 'block';
                    card.setAttribute('aria-hidden', 'false');
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                    card.setAttribute('aria-hidden', 'true');
                }
            });
            
            // Announce results for screen readers
            if (searchTerm) {
                const announcement = document.createElement('div');
                announcement.className = 'sr-only';
                announcement.setAttribute('role', 'status');
                announcement.setAttribute('aria-live', 'polite');
                announcement.textContent = `${visibleCount} resources found for "${searchTerm}"`;
                document.body.appendChild(announcement);
                setTimeout(() => announcement.remove(), 1000);
            }
        }, 300));
    }
    
    // Lazy loading with Intersection Observer
    function initLazyLoading() {
        if ('IntersectionObserver' in window) {
            const lazyImages = document.querySelectorAll('img[loading="lazy"]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.getAttribute('src');
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.1
            });
            
            lazyImages.forEach(img => imageObserver.observe(img));
        }
    }
    
    // Accessibility enhancements
    function initAccessibility() {
        // Add keyboard navigation to category filters
        const categoryButtons = document.querySelectorAll('.category-btn');
        categoryButtons.forEach((button, index) => {
            button.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    const nextIndex = (index + 1) % categoryButtons.length;
                    categoryButtons[nextIndex].focus();
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    const prevIndex = (index - 1 + categoryButtons.length) % categoryButtons.length;
                    categoryButtons[prevIndex].focus();
                } else if (e.key === 'Home') {
                    e.preventDefault();
                    categoryButtons[0].focus();
                } else if (e.key === 'End') {
                    e.preventDefault();
                    categoryButtons[categoryButtons.length - 1].focus();
                }
            });
        });
        
        // Skip to main content link
        const skipLink = document.createElement('a');
        skipLink.href = '#main-content';
        skipLink.className = 'skip-to-content';
        skipLink.textContent = 'Skip to main content';
        document.body.insertBefore(skipLink, document.body.firstChild);
    }
    
    // Utility: Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
})();